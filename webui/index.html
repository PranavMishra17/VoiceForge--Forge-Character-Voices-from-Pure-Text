<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VoiceForge UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 2.5em;
    }
    h1::before { content: "üé≠ "; }
    small { color: #666; }
    section {
      border: 1px solid #ddd;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      background: #fafafa;
    }
    section h3 {
      margin-top: 0;
      color: #667eea;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }
    label {
      display: block;
      margin: 10px 0 4px;
      font-weight: 600;
      color: #555;
    }
    input[type=text], input[type=number], textarea, select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    button {
      padding: 10px 20px;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 10px 0;
    }
    .audio-list li {
      margin: 12px 0;
      padding: 10px;
      background: white;
      border-radius: 6px;
    }
    .status {
      white-space: pre-wrap;
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      border: 2px solid #667eea;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
    }
    .hint {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
    }
    .success { color: #22c55e; font-weight: 600; }
    .error { color: #ef4444; font-weight: 600; }
    audio { width: 100%; margin-top: 10px; }
    #synthResult { margin-top: 15px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>VoiceForge</h1>
    <small>Advanced Text-to-Speech with Emotion, Tone, and Multilingual Support</small>

    <section>
      <h3>‚öôÔ∏è Configuration</h3>
      <div class="row">
        <div>
          <label>Output Directory</label>
          <input id="outputDir" type="text" placeholder="voiceforge_output" />
        </div>
        <div>
          <label>Speaker DB Path</label>
          <input id="speakerDb" type="text" placeholder="voiceforge_output/speakers/speaker_database.json" />
        </div>
      </div>
      <button onclick="applyConfig()">Apply Configuration</button>
    </section>

    <section>
      <h3>üë• Speakers</h3>
      <div class="row">
        <div>
          <label>Available Speakers</label>
          <select id="speakerSelect" size="1"></select>
        </div>
        <div style="align-self:end">
          <button onclick="refreshSpeakers()">üîÑ Refresh</button>
          <button onclick="deleteSpeaker()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%)">üóëÔ∏è Delete</button>
        </div>
      </div>
    </section>

    <section>
      <h3>üéôÔ∏è Extract Speaker Embedding</h3>
      <label>Audio File</label>
      <input id="extractAudio" type="file" accept="audio/*" />
      <div class="hint">Upload a clean audio sample of the speaker (WAV, MP3, FLAC)</div>

      <label>Transcript</label>
      <input id="extractTranscript" type="text" placeholder="What the speaker says in the audio..." />
      <div class="hint">Enter the exact transcript of the audio</div>

      <label>Speaker ID</label>
      <input id="extractSpeakerId" type="text" placeholder="wizard_voice" />
      <div class="hint">Unique identifier for this speaker</div>

      <button onclick="extractEmbedding()">üéØ Extract Embedding</button>
    </section>

    <section>
      <h3>üìÅ Add Speaker from Embedding File</h3>
      <label>Embedding File (.npy or .json)</label>
      <input id="embeddingFile" type="file" accept=".npy,.json" />
      <div class="hint">Pre-extracted 192-dimensional speaker embedding</div>

      <label>Speaker ID</label>
      <input id="embeddingSpeakerId" type="text" placeholder="custom_voice" />

      <label>Transcript / Description</label>
      <input id="embeddingTranscript" type="text" placeholder="Describe the speaker..." />

      <button onclick="addEmbedding()">‚ûï Add Speaker</button>
    </section>

    <section>
      <h3>üé§ Synthesize Speech</h3>
      <label>Text to Synthesize</label>
      <textarea id="synthText" rows="3" placeholder="Enter the text you want to convert to speech..."></textarea>

      <div class="row">
        <div>
          <label>Output Name</label>
          <input id="synthOutput" type="text" placeholder="my_audio" />
          <div class="hint">Name for the generated audio file</div>
        </div>
        <div>
          <label>Speaker ID (optional)</label>
          <input id="synthSpeaker" type="text" placeholder="wizard_voice" />
          <div class="hint">Use extracted speaker or leave empty for prompt audio</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Language</label>
          <select id="synthLanguage">
            <option value="">Auto-detect</option>
            <optgroup label="Primary Languages">
              <option value="english">English</option>
              <option value="chinese">Chinese (Mandarin)</option>
              <option value="japanese">Japanese</option>
              <option value="korean">Korean</option>
            </optgroup>
            <optgroup label="Chinese Dialects">
              <option value="cantonese">Cantonese</option>
              <option value="shanghainese">Shanghainese (Wu)</option>
              <option value="minnan">Min Nan</option>
              <option value="sichuanese">Sichuanese</option>
            </optgroup>
            <optgroup label="European Languages">
              <option value="german">German</option>
              <option value="spanish">Spanish</option>
              <option value="french">French</option>
              <option value="italian">Italian</option>
              <option value="russian">Russian</option>
              <option value="portuguese">Portuguese</option>
            </optgroup>
            <optgroup label="Other Languages">
              <option value="japanese">Japanese</option>
              <option value="arabic">Arabic</option>
              <option value="hindi">Hindi</option>
              <option value="thai">Thai</option>
              <option value="vietnamese">Vietnamese</option>
            </optgroup>
            <optgroup label="Mixed">
              <option value="mixed">Chinese-English Mixed</option>
            </optgroup>
          </select>
          <div class="hint">Output language (uses language tags)</div>
        </div>

        <div>
          <label>Emotion</label>
          <select id="synthEmotion">
            <option value="">None</option>
            <option value="happy">üòä Happy</option>
            <option value="sad">üò¢ Sad</option>
            <option value="angry">üò† Angry</option>
            <option value="excited">ü§© Excited</option>
            <option value="calm">üòå Calm</option>
            <option value="nervous">üò∞ Nervous</option>
            <option value="confident">üòé Confident</option>
            <option value="mysterious">ü§î Mysterious</option>
            <option value="dramatic">üé≠ Dramatic</option>
            <option value="gentle">üå∏ Gentle</option>
            <option value="energetic">‚ö° Energetic</option>
            <option value="romantic">üíï Romantic</option>
          </select>
          <div class="hint">Emotional expression</div>
        </div>

        <div>
          <label>Tone</label>
          <select id="synthTone">
            <option value="">None</option>
            <option value="formal">Formal</option>
            <option value="casual">Casual</option>
            <option value="professional">Professional</option>
            <option value="friendly">Friendly</option>
            <option value="serious">Serious</option>
            <option value="playful">Playful</option>
            <option value="authoritative">Authoritative</option>
            <option value="whispering">Whispering</option>
            <option value="shouting">Shouting</option>
          </select>
          <div class="hint">Speaking style</div>
        </div>

        <div>
          <label>Speed</label>
          <input id="synthSpeed" type="number" value="1.0" step="0.1" min="0.5" max="2.0" />
          <div class="hint">0.5 = slow, 1.0 = normal, 2.0 = fast</div>
        </div>
      </div>

      <label>Custom Instruction (optional)</label>
      <input id="synthInstruction" type="text" placeholder="speak like an ancient wizard..." />
      <div class="hint">Natural language instruction for voice modulation</div>

      <label>Prompt Audio (optional - for voice cloning)</label>
      <input id="synthPromptAudio" type="file" accept="audio/*" />
      <div class="hint">Reference audio for real-time voice cloning</div>

      <label>Prompt Text (optional)</label>
      <input id="synthPromptText" type="text" placeholder="Transcript of prompt audio..." />

      <button onclick="synthesize()">üéµ Synthesize Speech</button>
      <div id="synthResult"></div>
    </section>

    <section>
      <h3>üìú Dialogue Processing</h3>
      <label>Dialogue Name</label>
      <input id="dialogueName" type="text" placeholder="fantasy_story" />
      <div class="hint">Name for this dialogue session</div>

      <label>Default Speaker</label>
      <input id="dialogueSpeaker" type="text" placeholder="narrator" />
      <div class="hint">Default speaker for lines without speaker tag</div>

      <label>Script</label>
      <textarea id="dialogueScript" rows="8" placeholder="Enter dialogue lines...

Examples:
[speaker:wizard,emotion:happy] Greetings, traveler!
[language:english,tone:formal] Welcome to our realm.
[emotion:excited,speed:1.2] I can't wait!
[language:chinese] ‰Ω†Â•Ω‰∏ñÁïåÔºÅ"></textarea>
      <div class="hint">Use tags: [speaker:id,language:lang,emotion:name,tone:style,speed:1.0]</div>

      <button onclick="runDialogue()">‚ñ∂Ô∏è Process Dialogue</button>
    </section>

    <section>
      <h3>üéµ Generated Audio Files</h3>
      <button onclick="refreshAudio()">üîÑ Refresh List</button>
      <ul id="audioList" class="audio-list"></ul>
    </section>

    <section>
      <h3>üìä Status</h3>
      <div id="status" class="status">Ready. Waiting for operations...</div>
    </section>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);

    function setStatus(text, isError = false) {
      const statusEl = $('#status');
      statusEl.textContent = text;
      statusEl.className = 'status ' + (isError ? 'error' : 'success');
    }

    async function refreshSpeakers() {
      try {
        const res = await fetch('/api/speakers');
        const data = await res.json();
        const sel = $('#speakerSelect');
        sel.innerHTML = '<option value="">-- Select Speaker --</option>';
        (data.speakers || []).forEach(id => {
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = id;
          sel.appendChild(opt);
        });
        setStatus(`Loaded ${data.speakers.length} speakers`);
      } catch (e) {
        setStatus('Error loading speakers: ' + e.message, true);
      }
    }

    async function deleteSpeaker() {
      const id = $('#speakerSelect').value;
      if (!id) {
        setStatus('Please select a speaker to delete', true);
        return;
      }
      if (!confirm(`Delete speaker "${id}"?`)) return;

      const form = new FormData();
      form.append('speaker_id', id);
      const res = await fetch('/api/delete_speaker', { method: 'POST', body: form });
      const data = await res.json();
      setStatus(`Deleted speaker: ${id}`);
      refreshSpeakers();
    }

    async function applyConfig() {
      const form = new FormData();
      const out = $('#outputDir').value.trim();
      const db = $('#speakerDb').value.trim();
      if (out) form.append('output_dir', out);
      if (db) form.append('speaker_db', db);

      const res = await fetch('/api/config', { method: 'POST', body: form });
      const data = await res.json();
      setStatus('Configuration applied successfully\n' + JSON.stringify(data, null, 2));
      refreshAudio();
      refreshSpeakers();
    }

    async function extractEmbedding() {
      const audio = $('#extractAudio').files[0];
      const transcript = $('#extractTranscript').value;
      const speakerId = $('#extractSpeakerId').value;

      if (!audio || !transcript || !speakerId) {
        setStatus('Please provide audio, transcript, and speaker ID', true);
        return;
      }

      const form = new FormData();
      form.append('audio', audio);
      form.append('transcript', transcript);
      form.append('speaker_id', speakerId);

      setStatus('Extracting speaker embedding...');
      const res = await fetch('/api/extract', { method: 'POST', body: form });
      const data = await res.json();

      if (data.ok) {
        setStatus(`‚úÖ Successfully extracted embedding for "${speakerId}"`);
        refreshSpeakers();
      } else {
        setStatus('‚ùå Extraction failed\n' + JSON.stringify(data, null, 2), true);
      }
    }

    async function addEmbedding() {
      const file = $('#embeddingFile').files[0];
      const speakerId = $('#embeddingSpeakerId').value;
      const transcript = $('#embeddingTranscript').value;

      if (!file || !speakerId) {
        setStatus('Please provide embedding file and speaker ID', true);
        return;
      }

      const form = new FormData();
      form.append('embedding_file', file);
      form.append('speaker_id', speakerId);
      form.append('transcript', transcript);

      setStatus('Adding speaker from embedding...');
      const res = await fetch('/api/add_embedding', { method: 'POST', body: form });
      const data = await res.json();

      if (data.ok) {
        setStatus(`‚úÖ Successfully added speaker "${speakerId}"`);
        refreshSpeakers();
      } else {
        setStatus('‚ùå Failed to add speaker\n' + JSON.stringify(data, null, 2), true);
      }
    }

    async function synthesize() {
      const text = $('#synthText').value;
      const outputName = $('#synthOutput').value;

      if (!text || !outputName) {
        setStatus('Please provide text and output name', true);
        return;
      }

      const form = new FormData();
      form.append('text', text);
      form.append('output_name', outputName);
      form.append('speaker_id', $('#synthSpeaker').value);
      form.append('instruction', $('#synthInstruction').value);
      form.append('emotion', $('#synthEmotion').value);
      form.append('tone', $('#synthTone').value);
      form.append('speed', $('#synthSpeed').value);
      form.append('language', $('#synthLanguage').value);

      if ($('#synthPromptAudio').files[0]) {
        form.append('prompt_audio', $('#synthPromptAudio').files[0]);
      }
      form.append('prompt_text', $('#synthPromptText').value);

      setStatus('Synthesizing speech...\nLanguage: ' + ($('#synthLanguage').value || 'auto-detect') +
                '\nEmotion: ' + ($('#synthEmotion').value || 'none') +
                '\nTone: ' + ($('#synthTone').value || 'none') +
                '\nSpeed: ' + $('#synthSpeed').value + 'x');

      const res = await fetch('/api/synthesize', { method: 'POST', body: form });
      const data = await res.json();

      if (data.ok && data.output_path) {
        setStatus(`‚úÖ Speech synthesized successfully!\nOutput: ${data.output_path}`);

        const a = document.createElement('audio');
        a.controls = true;
        const name = data.output_path.split(/[/\\]/).pop();
        a.src = '/api/audio/' + name;
        $('#synthResult').innerHTML = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;"><strong>üéµ Generated Audio:</strong></div>';
        $('#synthResult').appendChild(a);
        refreshAudio();
      } else {
        setStatus('‚ùå Synthesis failed\n' + JSON.stringify(data, null, 2), true);
      }
    }

    async function runDialogue() {
      const dialogueName = $('#dialogueName').value;
      const scriptText = $('#dialogueScript').value;

      if (!dialogueName || !scriptText) {
        setStatus('Please provide dialogue name and script', true);
        return;
      }

      const form = new FormData();
      form.append('dialogue_name', dialogueName);
      form.append('default_speaker', $('#dialogueSpeaker').value);
      form.append('script_text', scriptText);

      setStatus('Processing dialogue script...');
      const res = await fetch('/api/dialogue', { method: 'POST', body: form });
      const data = await res.json();

      if (data.ok) {
        const count = data.results ? data.results.length : 0;
        setStatus(`‚úÖ Dialogue processed successfully!\nGenerated ${count} audio files`);
        refreshAudio();
      } else {
        setStatus('‚ùå Dialogue processing failed\n' + JSON.stringify(data, null, 2), true);
      }
    }

    async function refreshAudio() {
      try {
        const res = await fetch('/api/audio_list');
        const data = await res.json();
        const ul = $('#audioList');
        ul.innerHTML = '';

        if (!data.audio || data.audio.length === 0) {
          ul.innerHTML = '<li style="color: #888;">No audio files generated yet</li>';
          return;
        }

        data.audio.forEach(item => {
          const li = document.createElement('li');
          const cap = document.createElement('div');
          cap.style.fontWeight = '600';
          cap.style.marginBottom = '5px';
          cap.textContent = item.name + ' (' + Math.round(item.size/1024) + ' KB)';

          const a = document.createElement('audio');
          a.controls = true;
          a.src = item.path;

          li.appendChild(cap);
          li.appendChild(a);
          ul.appendChild(li);
        });
      } catch (e) {
        setStatus('Error loading audio list: ' + e.message, true);
      }
    }

    async function init() {
      try {
        const statsRes = await fetch('/api/stats');
        const stats = await statsRes.json();
        $('#outputDir').value = stats.output_base_dir || '';
        $('#speakerDb').value = stats.speaker_database_path || '';
        setStatus(`‚úÖ VoiceForge loaded successfully!\nSpeakers: ${stats.speaker_count || 0}\nModel: ${stats.model_path || 'N/A'}`);
      } catch (e) {
        setStatus('‚ö†Ô∏è Warning: Could not load initial stats\n' + e.message);
      }
      refreshSpeakers();
      refreshAudio();
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
